---
title: "Final Project"
author: "Dai Dong"
date: "1/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

[Link to CDC's website](https://covid.cdc.gov/covid-data-tracker/#trends_dailytrendscases)

Load libraries
```{r, message=FALSE, warning=FALSE}
library(TSA)
library(lubridate)
library(tidyverse)
library(forecast)
library(ggplot2)
library(tseries)
library(gridExtra)
library(knitr)
```

Read and clean data
```{r}
data <- read.csv("data_table_for_daily_death_trends__california.csv", skip=2)

# Change the data type of the Date column
data <- data %>%
  mutate(Date = mdy(Date)) %>%
  select(-c(State, X7.Day.Moving.Avg))

# Reverse the order of the data
data <- data %>% map_df(rev)
head(data)
```

Since COVID-19 was declared as a global pandemic on March 11, 2020 and there were barely no deaths due to COVID-19 in California before March 11, 2020, we decided to only analyze data after March 11, 2020.

```{r}
# Delete the first 49 observations
data <- tail(data, nrow(data)-49)
head(data)
```

Create a time-series object
```{r}
## Create a daily Date object - helps my work on dates
# inds <- seq(as.Date("2020-01-22"), as.Date("2021-04-24"), by = "day")
# cali_ts <- ts(data[,2], start = c(2020, as.numeric(format(inds[1], "%j"))), frequency = 365)
cali_ts <- ts(data[,2], start = 1)
```

Split data into the training and test set.
```{r}
# Training set
# From March 11, 2020 to April 19, 2021
cali_train <- window(cali_ts, end=c(405)) 

# Test set
# From April 20, 2021 to April 26, 2021
cali_test <- window(cali_ts, start=c(406), end=c(412))
```

Create a time-series plot for the whole data
```{r}
ggplot(data, aes(x=Date, y=New.Deaths)) +
  geom_line() + 
  scale_x_date(date_breaks = "3 month", date_labels = "%b-%Y") +
  labs(x = "Time",
       y = "New Deaths",
       title = "Number of Daily Deaths in California, United States",
       subtitle = "From March 11, 2020 to April 26, 2021", 
       caption = "Source: Centers for Disease Control and Prevention (CDC)")+
  theme_bw()
```

Create a time-series plot for the training data set.
```{r}
autoplot(cali_train) +
  labs(x = "Time",
       y = "New Deaths",
       title = "Number of Daily Deaths in California, United States",
       subtitle = "From March 11, 2020 to April 19, 2021", 
       caption = "Source: Centers for Disease Control and Prevention (CDC)")+
  theme_bw()
```

Based on the time series plot, it is clear that the series is not stationary. The mean and variance increase after December 2020. Therefore, the mean and variance depend on time.

```{r}
ggAcf(cali_train, lag.max = 30) + 
  labs(title = "ACF of Daily Deaths in California, United States",
       subtitle = "From March 11, 2020 to April 26, 2021", 
       caption = "Source: Centers for Disease Control and Prevention (CDC)") + 
  theme_bw()
```

The ACF plot shows a slow decay which indicates a non-stationary process. \

Even though it is clear that the series is not stationary, we will use the Dickey-Fuller test to further back up our observation. The test is given by
\begin{align*}
H_0: \alpha = 1 \\
H_A: \alpha < 1
\end{align*}
```{r}
adf.test(cali_train)
```

Because the p-value is so high (p-value = 0.9899), we can conclude that we fail to reject the null hypothesis test. It means that the series is not stationary. \

We will try the differencing method to make the series stationary. The plot below is the first differences of the daily deaths in California series. `auto.arima()` function in R will be used to select the best ARIMA model according to either AIC, AICc, or BIC criteria.

```{r}
# Best model based on BIC criterion
auto.arima(cali_train, ic="bic")
```

```{r}
# Best model based on AIC criterion
auto.arima(cali_train, ic="aic")
```

```{r}
# Best model based on AICC criterion
auto.arima(cali_train, ic="aicc")
```

The `auto.arima()` function suggests the ARIMA(4,1,2) model as chosen by all 3 criteria. \

We'll investigate the time-series, ACF, and PACF plots of the first differencing of the daily deaths in California, United States.

```{r}
autoplot(diff(cali_train)) +
  labs(x = "Time",
       y = "New Deaths",
       title = "Time Series Plot of the First Difference of Daily Deaths in California, United States",
       subtitle = "From March 11, 2020 to April 19, 2021", 
       caption = "Source: Centers for Disease Control and Prevention (CDC)")+
  theme_bw()
```

From the plot, it seems that the series is not stationary since the variance seems to increase after $t=300$. However, the mean does not depend on time after we applied the first differencing. We'll confirm our assumption by using the Dickey-Fuller test again.

```{r}
adf.test(diff(cali_train))
```

The p-value is less than 0.01 which is less than the significance level ($\alpha = 0.05$). Therefore, we have enough evidence to conclude that the first differencing of the series is stationary. \

We next will look at the ACF and PACF plots.

```{r}
grid.arrange(
  ggAcf(diff(cali_train), lag.max = 30) + 
    labs(title = "ACF of Daily Deaths in California") + 
    theme_bw(),
  ggPacf(diff(cali_train), lag.max = 30) + 
    labs(title = "PACF of Daily Deaths in California") + 
    theme_bw(),
  
  nrow = 1)
```

The ACF plot of the first differencing shows the potential of an AR model since the autocorrelation decays. By eyeballing the ACF plot, we don't think that it is suitable to include the MA part in the model. On the other hand, the PACF plot displays a cut-off after lag 6, which is an indicator of AR(6) part in the ARIMA(p,d,q) model. If we don't use the `auto.arima()` function, the model we pick will be ARI(6,1). We'll consider both ARIMA(4,1,2) and ARI(6,1) model.\

Fit ARIMA(4,1,2) model.
```{r}
arima_mod <- auto.arima(cali_train)
arima_mod
```

Fit ARI(6,1) model.
```{r}
ari_mod <- Arima(cali_train, order=c(6, 1, 0))
ari_mod
```

We need to check stationary for the AR(6,1) model using the unit root test. 
```{r}
Mod(polyroot(c(1, 0.6453, 0.6389, 0.6579 , 0.6421, 0.6389, 0.4276)))
```

All moduli are greater than 1 which means that the lengths of the moduli exceed the radius of the unit circle. Therefore, the fitted ARI(6,1) model is stationary. \

From the first time-series plot of the whole data, we conclude that the variance is not constant over time. We can stabilize the series using the log transformation method. In particular, we will do log(x+1) transformation because there are some 0 values in our training data.

```{r}
autoplot(log(cali_train + 1)) +
  labs(title = "Log Transformation Plot of the Daily Deaths in California, United States",
       subtitle = "From March 11, 2020 to April 19, 2021", 
       caption = "Source: Centers for Disease Control and Prevention (CDC)") + 
  theme_bw()
```

We can see that the variance looks more constant after doing log transformation. However, the mean varies over time. Thus, this transformed process is still not stationary.

```{r}
adf.test(log(cali_train+1))
```

The Dickey-Fuller test also confirms our conclusion. The p-value is greater than the significance level (0.1889 > 0.05), so the log-transformed series is not stationary. \

We will use `auto.arima()` to pick the best model.

```{r}
# Best model based on BIC criterion
auto.arima(log(cali_train+1), ic="bic")
```

```{r}
# Best model based on AIC criterion
auto.arima(log(cali_train+1), ic="aic")
```

```{r}
# Best model based on AICC criterion
auto.arima(log(cali_train+1), ic="aicc")
```

AIC and AICC criteria select ARIMA(5,1,3) model, while BIC criterion picks ARIMA(5,1,2) model. We'll look at ACF and PACF plot to see which model is more suitable.

```{r}
autoplot(diff(log(cali_train + 1))) +
  labs(title = "First Differencing of the Log Transformation of the Daily Deaths in California",
       subtitle = "From March 11, 2020 to April 19, 2021", 
       caption = "Source: Centers for Disease Control and Prevention (CDC)") + 
  theme_bw()
```

The time-series plot above suggests a stationary time-series.

```{r}
grid.arrange(
  ggAcf(diff(log(cali_train + 1)), lag.max = 30) + 
    labs(title = "ACF Plot") + 
    theme_bw(),
  ggPacf(diff(log(cali_train + 1)), lag.max = 30) + 
    labs(title = "PACF Plot") + 
    theme_bw(),
  
  nrow = 1)
```

Based on both ACF and PACF plots, the ARIMA(5,1,2) seems to be more appropriate since there is a cut-off after lag 2 and lag 6 in the ACF and PACF plot respectively. However, we will consider both models. \

Fit ARIMA(5,1,2) model.
```{r}
arima_log_mod1 <- auto.arima(log(cali_train+1), ic="bic")
arima_log_mod1 
```

Fit ARIMA(5,1,3) model.
```{r}
arima_log_mod2 <- auto.arima(log(cali_train+1), ic="aic")
arima_log_mod2 
```

Besides the ARIMA models, we will also consider the exponential smoothing and Holt-Winters (trend component only) Models (only fitting additive models because the multiplicative model cannot be used when the original time series has 0 values). \

Fit an additive exponential smoothing model.
```{r}
cali.exp.add <- HoltWinters(cali_train, beta=FALSE, gamma=FALSE, seasonal = c("additive"))
cali.exp.add
```

Fit an additive Holt Model for trend only.
```{r}
cali.trend.add <- HoltWinters(cali_train, gamma=FALSE, seasonal = c("additive"))
cali.trend.add
```

We will fit 6 models to the test set.
```{r}
arima_mod_est <- forecast(arima_mod, h=length(cali_test))
ari_mod_est <- forecast(ari_mod, h=length(cali_test))
arima_log_mod1_est <- forecast(arima_log_mod1, h=length(cali_test))
arima_log_mod2_est <- forecast(arima_log_mod2, h=length(cali_test))
cali.exp.add_est <- forecast(cali.exp.add, h=length(cali_test))
cali.trend.add_est <- forecast(cali.trend.add, h=length(cali_test))
```

Plot the predicted daily death of four models (except for two log-transfored models) along with the actual daily deaths.
```{r}
autoplot(window(cali_train, start=c(390))) + 
  autolayer(arima_mod_est, PI=FALSE, series="ARIMA(4,1,2) ") +
  autolayer(ari_mod_est, PI=FALSE, series="ARI(6,1)") +
  autolayer(cali.exp.add_est, PI=FALSE, series="Exp Smoothing") +
  autolayer(cali.trend.add_est, PI=FALSE, series="HW Trend Only") +
  autolayer(cali_test, series="True Daily Deaths", size=1.5) +
  labs(x="Time", 
       y="Daily Deaths",
       title="Model Comparison: Forcasted Daily Deaths in California",
       subtitle = "From April 4, 2021 to April 26, 2020",
       caption="Source: Centers for Disease Control and Prevention (CDC)") +
  theme_bw()
```

Plot the predicted daily death of 2 transformed models along with the actual daily deaths.
```{r}
autoplot(window(log(cali_train+1), start=c(390))) + 
  autolayer(arima_log_mod1_est, PI=FALSE, series="Log-transformed ARIMA(5,1,2)") +
  autolayer(arima_log_mod2_est, PI=FALSE, series="Log-transformed ARIMA(5,1,3)") +
  autolayer(log(cali_test+1), series="True Daily Deaths", size=1.5) +
  labs(x="Time", 
       y="Daily Deaths",
       title="Model Comparison: Forcasted Daily Deaths in California",
       subtitle = "From April 4, 2021 to April 26, 2020",
       caption="Source: Centers for Disease Control and Prevention (CDC)") +
  theme_bw()
```


Summary table reports the RMSE, MAE, and MAPE of 4 models (except for 2 log-transformed models)
```{r}
summary_table <- rbind(accuracy(arima_mod_est, cali_test)[2,c(2, 3, 5)],
                       accuracy(ari_mod_est, cali_test)[2,c(2, 3, 5)],
                       accuracy(cali.exp.add_est, cali_test)[2,c(2, 3, 5)],
                       accuracy(cali.trend.add_est, cali_test)[2,c(2, 3, 5)])
rownames(summary_table) <- c("ARIMA(4,1,2)", "ARI(6,1)", "Additive Exp Smoothing", "Additive HW (Trend)")
kable(summary_table)
```

Based on the summary table, ARI(6,1) is the best model among 4 non-transformed models since it has the lowest test RMSE, MAE, and MAPE scores. \

Summary table reports the RMSE, MAE, and MAPE of all 2 log-transformed models.
```{r}
summary_table <- rbind(accuracy(arima_log_mod1_est, log(cali_test+1))[2,c(2, 3, 5)],
                       accuracy(arima_log_mod2_est, log(cali_test+1))[2,c(2, 3, 5)])
rownames(summary_table) <- c("Log-transformed ARIMA(5,1,2)", "Log-transformed ARIMA(5,1,3)")
kable(summary_table)
```

Based on the summary table, the log-transformed ARIMA(5,1,3) is a better model compared to the ARIMA(5,1,2) model since it has smaller RMSE, MAE, and MAPE scores. \ 

We will further investigate the non-transformed ARI(6,1) and log-transformed ARIMA(5,1,3) models. \

Refit ARI(6,1) model to the whole data set.
```{r}
ari_mod_full <- Arima(cali_ts, order=c(6, 1, 0))
ari_mod_full
```

Refit log-transformed ARIMA(5,1,3) model to the whole data set.
```{r}
arima_log_mod2_full <- Arima(log(cali_ts+1), order=c(5, 1, 3))
arima_log_mod2_full
```

We can check if there are any irregular patterns of ARI(6,1) and log-transformed ARIMA(5,1,3) models by constructing the time-series plot of the standardized residuals.

```{r}
# A function creates a standardized residual data frame.
stR_df <- function(model, ts) {
  stand_resi <- rstandard(model)
  stResi_ts <- ts(stand_resi)
  stResi_df <- data.frame(stResid = stResi_ts, 
                          time = trunc(time(ts)))
  
  return (stResi_df)
}
```


```{r, message=FALSE}
# ARI(6,1) model
stResidual_df1 <- stR_df(ari_mod_full, cali_ts)

ggplot(aes(x=time, y=stResid), data=stResidual_df1) +
  geom_line() +
  geom_point(shape=1) +
  geom_hline(yintercept=0) +
  labs(x = "Time",
       y = "Standardized Residuals",
       title = "Residuals from the ARI(6,1) Model", 
       subtitle = "From March 11, 2020 to April 26, 2020",
       caption="Source: Centers for Disease Control and Prevention (CDC)") +
  theme_bw()
```

From the plot above, it is possible that there are some irregular patterns after $t=300$.

```{r, message=FALSE}
# Log-transformed ARIMA(5,1,3) model
stResidual_df2 <- stR_df(arima_log_mod2_full, log(cali_ts+1))

ggplot(aes(x=time, y=stResid), data=stResidual_df2) +
  geom_line() +
  geom_point(shape=1) +
  geom_hline(yintercept=0) +
  labs(x = "Time",
       y = "Standardized Residuals",
       title = "Residuals from the Log-transformed ARIMA(5,1,3) Model", 
       subtitle = "From March 11, 2020 to April 26, 2020",
       caption="Source: Centers for Disease Control and Prevention (CDC)") +
  theme_bw()
```

Even though there are a few standard residual observations that go outside the normal range, they do not appear as patterns. Therefore, we can temporarily assume that there is no statistically significant correlation. \

We next check the ACF plot of the residuals.
```{r}
# ARI(6,1) model
ggAcf(rstandard(ari_mod_full), lag.max = 30) +
  labs(title  = "ACF of Residuals from the ARI(6,1) Model",
       subtitle = "From March 11, 2020 to April 9, 2020",
       caption="Source: Centers for Disease Control and Prevention (CDC)") +
  theme_bw()
```

We can see there are some statistically significant correlations. They do not seem to appear due to randomness.

```{r}
# Log-transformed ARIMA(5,1,3)
ggAcf(rstandard(arima_log_mod2_full), lag.max = 30) +
  labs(title  = "ACF of Residuals from the Log-transformed ARIMA(5,1,3) Model",
       subtitle = "From March 11, 2020 to April 9, 2020",
       caption="Source: Centers for Disease Control and Prevention (CDC)") +
  theme_bw()
```

On the other hand, there are only 3 significant correlation based on the ACF of residuals plot above and they seem to happen because of randomness. \

The Ljung-Box test is next used to analyze the possible significance of autocorrelation values in ARIMA model.

```{r}
# ARI(6,1) model
Box.test(residuals(ari_mod_full), lag=15, type="Ljung-Box", fitdf=6)
```

The ARI(6,1) model gives a chi-squared value of 60.779 with 9 degrees of freedom. The p-value is really small (<0.0001). This means that we do have sufficient evidence to infer that the error terms are uncorrelated. In other words, the ARI(6,1) model does not seem to be a good model.

```{r}
# Log-transformed ARIMA(5,1,3) model
Box.test(residuals(arima_log_mod2_full), lag=15, type="Ljung-Box", fitdf=8)
```

Since the p-value of the Ljung-Box test is large for the first 15 selected lags, we don’t have sufficient evidence to infer that the error terms are uncorrelated. Thus, the log-transformed ARIMA(5,1,3) seems to be a good model.

```{r}
# ARI(6,1) Model
tsdiag(ari_mod_full, gof.lag = 15, omit.initial=F)
```

The panel plot also suggests that ARI(6,1) model is not a good model since most of the p-values are all below the dashed line (the 5% line). Therefore, we can conclude that the ARI(6,1) model is not an appropriate model for predicting the number of daily deaths in California. \

We will check the panel plot of the log-transformed ARIMA(5,1,3) model as well.

```{r}
tsdiag(arima_log_mod2_full, gof.lag = 15, omit.initial=F)
```

The panel plot shows that the p-values are all above the dashed line (the 5% line). Therefore, we can conclude that the log-transformed ARIMA(5,1,3) model is an appropriate model for predicting the daily deaths in California. \

We will predict the number of daily deaths from April 27, 2021 to April 30, 2021
```{r}
daily.deaths.preds <- forecast(arima_log_mod2_full, h=4)
```

```{r}
autoplot(window(log(cali_ts+1), start=c(390))) +
  autolayer(daily.deaths.preds) +
  labs(x = "Time",
       y = "Daily Deaths",
       title="Forecasts and Forecast Limits for the Daily Deaths in California, United States",
       subtitle = "From April 4, 2020 to April 30, 2021",
       caption="Source: Centers for Disease Control and Prevention (CDC)") +
  theme_bw()
```

```{r}
# Rescale 4 predicted values
daily.deaths.preds.df <- as.data.frame(daily.deaths.preds) %>%
  mutate(Date = seq(as.Date("2021-04-27"), as.Date("2021-04-30"), by = "day")) %>%
  relocate(Date)
daily.deaths.preds.df$Retransform_Forecast <- exp(daily.deaths.preds.df[,2]) - 1
daily.deaths.preds.df <- daily.deaths.preds.df %>%
  select(Date, Retransform_Forecast)
daily.deaths.preds.df
```

From the plot, we can see that the predicted values follow the general pattern of the series. The estimated daily deaths on April 27, 2021 are about 18 people and increase to about 113 deaths on April 29, 2021. We also checked with the actual data provided by CDC and we can confirm that our predicted values from April 21, 2021 to April 30, 2021 match the general patterns of the series. The actual daily deaths statistic of California from April 21, 2021 to April 30, 2021 is provided below.

```{r}
daily.deaths.df <- daily.deaths.preds.df %>%
  rename(Forecast_Deaths = Retransform_Forecast)
daily.deaths.df$Actual_Deaths <- c(5, 65, 89, 105)
kable(daily.deaths.df)
```


